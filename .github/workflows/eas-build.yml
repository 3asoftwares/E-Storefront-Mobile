# EAS Build Workflow for E-Storefront Mobile
# Dedicated workflow for building and submitting mobile apps
#
# Usage:
# - Manually trigger from Actions tab
# - Automatically triggers on version tags (v*.*.*)

name: EAS Build & Submit

on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Build profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - development
          - preview
          - production
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - android
          - ios
          - all
      submit:
        description: 'Submit to app stores after build'
        required: false
        default: false
        type: boolean
      message:
        description: 'Build message/changelog'
        required: false
        default: ''
        type: string
  push:
    tags:
      - 'v*.*.*'

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # Validate & Prepare
  # ============================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      profile: ${{ steps.params.outputs.profile }}
      platform: ${{ steps.params.outputs.platform }}
      submit: ${{ steps.params.outputs.submit }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine build parameters
        id: params
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "profile=${{ github.event.inputs.profile }}" >> $GITHUB_OUTPUT
            echo "platform=${{ github.event.inputs.platform }}" >> $GITHUB_OUTPUT
            echo "submit=${{ github.event.inputs.submit }}" >> $GITHUB_OUTPUT
          else
            # Tag push - use production profile
            echo "profile=production" >> $GITHUB_OUTPUT
            echo "platform=all" >> $GITHUB_OUTPUT
            echo "submit=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION"

  # ============================================
  # Quality Gates
  # ============================================
  quality-check:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: TypeScript check
        run: yarn typecheck

      - name: Run tests
        run: yarn test --passWithNoTests --ci

  # ============================================
  # EAS Build
  # ============================================
  eas-build:
    runs-on: ubuntu-latest
    needs: [prepare, quality-check]
    outputs:
      android-build-id: ${{ steps.build.outputs.android-build-id }}
      ios-build-id: ${{ steps.build.outputs.ios-build-id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build message
        id: message
        run: |
          if [ -n "${{ github.event.inputs.message }}" ]; then
            echo "msg=${{ github.event.inputs.message }}" >> $GITHUB_OUTPUT
          else
            echo "msg=Build v${{ needs.prepare.outputs.version }} from ${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Start EAS Build
        id: build
        run: |
          echo "üöÄ Starting EAS Build..."
          echo "   Profile: ${{ needs.prepare.outputs.profile }}"
          echo "   Platform: ${{ needs.prepare.outputs.platform }}"
          echo "   Version: ${{ needs.prepare.outputs.version }}"
          echo ""

          BUILD_OUTPUT=$(eas build \
            --platform ${{ needs.prepare.outputs.platform }} \
            --profile ${{ needs.prepare.outputs.profile }} \
            --message "${{ steps.message.outputs.msg }}" \
            --non-interactive \
            --json 2>&1) || true

          echo "$BUILD_OUTPUT"

          # Extract build IDs if available
          if echo "$BUILD_OUTPUT" | grep -q "buildId"; then
            ANDROID_ID=$(echo "$BUILD_OUTPUT" | jq -r '.[] | select(.platform == "ANDROID") | .id // empty')
            IOS_ID=$(echo "$BUILD_OUTPUT" | jq -r '.[] | select(.platform == "IOS") | .id // empty')
            echo "android-build-id=$ANDROID_ID" >> $GITHUB_OUTPUT
            echo "ios-build-id=$IOS_ID" >> $GITHUB_OUTPUT
          fi

          echo "‚úÖ Build submitted successfully!"

      - name: Build Summary
        run: |
          echo "## üì± EAS Build Submitted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Profile** | ${{ needs.prepare.outputs.profile }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Platform** | ${{ needs.prepare.outputs.platform }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ needs.prepare.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó [View builds on Expo Dashboard](https://expo.dev/accounts/3asoftwares/projects/3asoftwares/builds)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Submit to App Stores (Optional)
  # ============================================
  submit-android:
    runs-on: ubuntu-latest
    needs: [prepare, eas-build]
    if: needs.prepare.outputs.submit == 'true' && (needs.prepare.outputs.platform == 'android' || needs.prepare.outputs.platform == 'all')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Submit to Google Play
        run: |
          echo "üì§ Submitting Android build to Google Play..."
          eas submit --platform android --profile production --latest --non-interactive
          echo "‚úÖ Submitted to Google Play Store!"

  submit-ios:
    runs-on: ubuntu-latest
    needs: [prepare, eas-build]
    if: needs.prepare.outputs.submit == 'true' && (needs.prepare.outputs.platform == 'ios' || needs.prepare.outputs.platform == 'all')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Submit to App Store
        run: |
          echo "üì§ Submitting iOS build to App Store Connect..."
          eas submit --platform ios --profile production --latest --non-interactive
          echo "‚úÖ Submitted to App Store Connect!"

  # ============================================
  # Notification
  # ============================================
  notify:
    runs-on: ubuntu-latest
    needs: [prepare, eas-build]
    if: always()
    steps:
      - name: Build Status Summary
        run: |
          if [ "${{ needs.eas-build.result }}" == "success" ]; then
            echo "‚úÖ EAS Build completed successfully!"
            echo "   Version: ${{ needs.prepare.outputs.version }}"
            echo "   Profile: ${{ needs.prepare.outputs.profile }}"
          else
            echo "‚ùå EAS Build failed!"
            exit 1
          fi
