# GitLab CI/CD Pipeline for E-Storefront Mobile App
# Expo/React Native Mobile Application

# ============================================
# Global Configuration
# ============================================

image: node:20-alpine

variables:
  NODE_VERSION: "20"
  EXPO_TOKEN: $EXPO_TOKEN
  EAS_NO_VCS: "1"
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  CACHE_COMPRESSION_LEVEL: "fast"
  GIT_DEPTH: 50
  # SonarQube Configuration
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"

# ============================================
# Cache Configuration
# ============================================

.node_cache: &node_cache
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/
  policy: pull-push

# ============================================
# Workflow Rules
# ============================================

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_TAG

# ============================================
# Stages
# ============================================

stages:
  - install
  - quality
  - test
  - sonar
  - build
  - sync

# ============================================
# Stage Templates
# ============================================

.base_job:
  before_script:
    - apk add --no-cache git
    - npm ci --cache .npm --prefer-offline
  cache:
    <<: *node_cache

# ============================================
# Install Stage
# ============================================

Install Dependencies:
  stage: install
  script:
    - apk add --no-cache git
    - npm ci --cache .npm --prefer-offline
    - npm install -g eas-cli
    - echo "âœ… Dependencies installed successfully"
  cache:
    <<: *node_cache
    policy: push
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

# ============================================
# Code Quality Stage
# ============================================

TypeScript Check:
  stage: quality
  extends: .base_job
  needs:
    - job: Install Dependencies
  script:
    - echo "ðŸ” Running TypeScript type checking..."
    - npm run typecheck
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

ESLint Check:
  stage: quality
  extends: .base_job
  needs:
    - job: Install Dependencies
  script:
    - echo "ðŸ” Running ESLint..."
    - npm run lint
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

Format Check:
  stage: quality
  extends: .base_job
  needs:
    - job: Install Dependencies
  script:
    - echo "ðŸ” Checking code formatting..."
    - npm run format:check
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ============================================
# Test Stage
# ============================================

Unit Tests:
  stage: test
  extends: .base_job
  needs:
    - job: Install Dependencies
  script:
    - echo "ðŸ§ª Running unit tests with coverage..."
    - npm test -- --passWithNoTests --ci --coverage
  artifacts:
    name: "coverage-${CI_COMMIT_SHORT_SHA}"
    paths:
      - coverage/
    expire_in: 1 day
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# ============================================
# SonarCloud Stage
# ============================================

SonarCloud Analysis:
  stage: sonar
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  needs:
    - job: Unit Tests
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - echo "ðŸ“Š Running SonarCloud Analysis..."
    - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    - echo "ðŸ“‹ SonarCloud Configuration:"
    - echo "   Project Key - 3asoftwares_E-Storefront-Mobile"
    - echo "   Organization - 3asoftwares"
    - echo "   Host URL - https://sonarcloud.io"
    - echo "   Branch - ${CI_COMMIT_REF_NAME}"
    - if [ -z "$SONAR_TOKEN" ]; then echo "   âŒ SONAR_TOKEN NOT SET!"; else echo "   âœ… SONAR_TOKEN is set"; fi
    - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    - sonar-scanner -Dsonar.host.url=https://sonarcloud.io -Dsonar.token=${SONAR_TOKEN} -Dsonar.branch.name=${CI_COMMIT_REF_NAME}
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# ============================================
# Build Stage
# ============================================

Build Web:
  stage: build
  extends: .base_job
  needs:
    - job: TypeScript Check
    - job: ESLint Check
    - job: Format Check
    - job: Unit Tests
    - job: SonarCloud Analysis
  script:
    - echo "ðŸŒ Building Web Application..."
    - npm run web:build
  artifacts:
    name: "web-build-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

Build Android Preview:
  stage: build
  extends: .base_job
  needs:
    - job: TypeScript Check
    - job: ESLint Check
    - job: Format Check
    - job: Unit Tests
    - job: SonarCloud Analysis
  script:
    - echo "ðŸ¤– Building Android Preview APK..."
    - if [ -z "$EXPO_TOKEN" ]; then echo "âŒ EXPO_TOKEN not set!" && exit 1; else echo "âœ… EXPO_TOKEN is set"; fi
    - npm install -g eas-cli
    - eas whoami
    - eas build --platform android --profile preview --non-interactive --no-wait
  environment:
    name: android-preview
    url: https://expo.dev
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

Build iOS Preview:
  stage: build
  extends: .base_job
  needs:
    - job: TypeScript Check
    - job: ESLint Check
    - job: Format Check
    - job: Unit Tests
    - job: SonarCloud Analysis
  script:
    - echo "ðŸŽ Building iOS Preview..."
    - if [ -z "$EXPO_TOKEN" ]; then echo "âŒ EXPO_TOKEN not set!" && exit 1; else echo "âœ… EXPO_TOKEN is set"; fi
    - npm install -g eas-cli
    - eas whoami
    - eas build --platform ios --profile preview --non-interactive --no-wait
  environment:
    name: ios-preview
    url: https://expo.dev
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# ============================================
# Sync Stage - Push to GitHub after merge to main
# ============================================

Sync to GitHub:
  stage: sync
  image: alpine:latest
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  before_script:
    - apk add --no-cache git
  script:
    - echo "ðŸ”„ Syncing to GitHub..."
    - git remote add github https://oauth2:${GITHUB_TOKEN}@github.com/3asoftwares/E-Storefront-Mobile.git || true
    - git push github HEAD:main --force
    - echo "âœ… Successfully synced to GitHub!"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
  needs:
    - job: Build Web
