# GitLab CI/CD Pipeline for E-Storefront Mobile App
# Expo/React Native Mobile Application
# 
# Pipeline Architecture:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Install â”‚ â†’ â”‚ Quality â”‚ â†’ â”‚  Test   â”‚ â†’ â”‚  Sonar  â”‚ â†’ â”‚  Build  â”‚ â†’ â”‚ Deploy  â”‚ â†’ â”‚  Sync   â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# TRIGGER RULES:
# - CI (Install â†’ Build): Runs on MR created/updated AND merge to main
# - CD (Deploy â†’ Sync):   Runs ONLY on merge to main branch
# - GitHub Sync:          Automatic on merge to main
#
# ============================================
# Global Configuration
# ============================================

image: node:20-alpine

variables:
  NODE_VERSION: "20"
  EXPO_TOKEN: $EXPO_TOKEN
  EAS_NO_VCS: "1"
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  CACHE_COMPRESSION_LEVEL: "fast"
  GIT_DEPTH: 50
  # SonarQube Configuration
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"

# ============================================
# Cache Configuration
# ============================================

.node_cache: &node_cache
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/
  policy: pull-push

# ============================================
# Workflow Rules
# ============================================

workflow:
  rules:
    # CI: Run on Merge Request created or updated
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # CI + CD: Run on merge to main branch
    - if: $CI_COMMIT_BRANCH == "main"
    # CD: Run on version tags for production releases
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# ============================================
# Stages
# ============================================

stages:
  - install
  - quality
  - test
  - sonar
  - build
  - deploy
  - sync

# ============================================
# Stage Templates
# ============================================

.base_job:
  before_script:
    - apk add --no-cache git
    - npm ci --cache .npm --prefer-offline
  cache:
    <<: *node_cache

# ============================================
# Install Stage
# ============================================

Install Dependencies:
  stage: install
  script:
    - apk add --no-cache git
    - npm ci --cache .npm --prefer-offline
    - npm install -g eas-cli
    - echo "âœ… Dependencies installed successfully"
  cache:
    <<: *node_cache
    policy: push
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

# ============================================
# Code Quality Stage
# ============================================

TypeScript Check:
  stage: quality
  extends: .base_job
  needs:
    - job: Install Dependencies
  script:
    - echo "ğŸ” Running TypeScript type checking..."
    - npm run typecheck
  allow_failure: false
  rules:
    # CI: Run on MR and main merge
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

ESLint Check:
  stage: quality
  extends: .base_job
  needs:
    - job: Install Dependencies
  script:
    - echo "ğŸ” Running ESLint..."
    - npm run lint
  allow_failure: true
  rules:
    # CI: Run on MR and main merge
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

Format Check:
  stage: quality
  extends: .base_job
  needs:
    - job: Install Dependencies
  script:
    - echo "ğŸ” Checking code formatting..."
    - npm run format:check
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ============================================
# Test Stage
# ============================================

Unit Tests:
  stage: test
  extends: .base_job
  needs:
    - job: Install Dependencies
  script:
    - echo "ğŸ§ª Running unit tests with coverage..."
    - npm test -- --passWithNoTests --ci --coverage
  artifacts:
    name: "coverage-${CI_COMMIT_SHORT_SHA}"
    paths:
      - coverage/
    expire_in: 1 day
  allow_failure: true
  rules:
    # CI: Run on MR and main merge
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# ============================================
# SonarCloud Stage
# ============================================

SonarCloud Analysis:
  stage: sonar
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  needs:
    - job: Unit Tests
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - echo "ğŸ“Š Running SonarCloud Analysis..."
    - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    - echo "ğŸ“‹ SonarCloud Configuration:"
    - cat sonar-project.properties | grep -E "^sonar\.(projectKey|projectName|organization|host\.url)" || true
    - echo "   Branch - ${CI_COMMIT_REF_NAME}"
    - echo "   SONAR_TOKEN - [MASKED]"
    - if [ -z "$SONAR_TOKEN" ]; then echo "âŒ ERROR - SONAR_TOKEN is not set!"; exit 1; fi
    - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    - sonar-scanner -Dsonar.host.url=https://sonarcloud.io -Dsonar.token=${SONAR_TOKEN} -Dsonar.branch.name=${CI_COMMIT_REF_NAME}
  allow_failure: true
  rules:
    # CI: Run on MR and main merge
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# ============================================
# Build Stage
# ============================================

Build Web:
  stage: build
  extends: .base_job
  needs:
    - job: TypeScript Check
    - job: ESLint Check
    - job: Format Check
      optional: true
    - job: Unit Tests
    - job: SonarCloud Analysis
  script:
    - echo "ğŸŒ Building Web Application..."
    - npm run web:build
  artifacts:
    name: "web-build-${CI_COMMIT_SHORT_SHA}"
    paths:
      - dist/
    expire_in: 1 week
  rules:
    # CI: Run on MR and main merge
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# ============================================
# EAS Build Stage - Mobile Builds
# ============================================

.eas_build_template:
  stage: build
  image: node:20
  needs:
    - job: TypeScript Check
    - job: Unit Tests
  before_script:
    - npm ci
    - npm install -g eas-cli
    - eas whoami || echo "Not logged in - using EXPO_TOKEN"
  cache:
    <<: *node_cache

# Preview Build (Android APK) - On develop branch
EAS Build Preview Android:
  extends: .eas_build_template
  script:
    - echo "ğŸ“± Starting EAS Preview Build for Android..."
    - eas build --platform android --profile preview --non-interactive --no-wait
    - echo "âœ… Build submitted to EAS! Check https://expo.dev for status."
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      when: manual
      allow_failure: true

# Preview Build (iOS) - On develop branch  
EAS Build Preview iOS:
  extends: .eas_build_template
  script:
    - echo "ğŸ“± Starting EAS Preview Build for iOS..."
    - eas build --platform ios --profile preview --non-interactive --no-wait
    - echo "âœ… Build submitted to EAS! Check https://expo.dev for status."
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      when: manual
      allow_failure: true

# Production Build (Both platforms) - On main branch with tag
EAS Build Production:
  extends: .eas_build_template
  script:
    - echo "ğŸš€ Starting EAS Production Build..."
    - eas build --platform all --profile production --non-interactive --no-wait
    - echo "âœ… Production build submitted to EAS!"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: manual
      allow_failure: true

# ============================================
# Deploy Stage - OTA Updates
# ============================================

# EAS Update for Preview (OTA) - CD: Only on main merge
EAS Update Preview:
  stage: deploy
  image: node:20
  needs:
    - job: Build Web
  before_script:
    - npm ci
    - npm install -g eas-cli
  script:
    - echo "ğŸ“¡ Publishing OTA Update to Preview channel..."
    - eas update --branch preview --message "Preview update from ${CI_COMMIT_SHORT_SHA}"
    - echo "âœ… OTA Update published to preview channel!"
  cache:
    <<: *node_cache
  rules:
    # CD: Only on main merge (manual trigger for preview testing)
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true

# EAS Update for Production (OTA) - CD: Only on main merge
EAS Update Production:
  stage: deploy
  image: node:20
  needs:
    - job: Build Web
  before_script:
    - npm ci
    - npm install -g eas-cli
  script:
    - echo "ğŸ“¡ Publishing OTA Update to Production channel..."
    - eas update --branch production --message "Production update ${CI_COMMIT_TAG:-$CI_COMMIT_SHORT_SHA}"
    - echo "âœ… OTA Update published to production channel!"
  cache:
    <<: *node_cache
  rules:
    # CD: Only on main merge (manual for safety)
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
      allow_failure: true
    # CD: Auto-trigger on version tags
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: on_success

# ============================================
# Sync Stage - Automatic Push to GitHub after merge to main
# ============================================

Sync to GitHub:
  stage: sync
  image: alpine:latest
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  before_script:
    - apk add --no-cache git
  script:
    - echo "ğŸ”„ Automatically syncing to GitHub main branch..."
    - echo "   GitLab commit: ${CI_COMMIT_SHA}"
    - echo "   Branch: ${CI_COMMIT_BRANCH}"
    - git config --global user.email "ci@3asoftwares.com"
    - git config --global user.name "GitLab CI"
    - git remote add github https://oauth2:${GITHUB_TOKEN}@github.com/3asoftwares/E-Storefront-Mobile.git 2>/dev/null || git remote set-url github https://oauth2:${GITHUB_TOKEN}@github.com/3asoftwares/E-Storefront-Mobile.git
    - git fetch github main --depth=1 || true
    - git push github HEAD:main --force
    - echo "âœ… Successfully synced to GitHub main branch!"
  rules:
    # AUTOMATIC: Sync to GitHub on every merge to main
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
  needs:
    - job: Build Web
