# GitLab CI/CD Pipeline for E-Storefront Mobile App
# Expo/React Native Mobile Application

# ============================================
# Global Configuration
# ============================================

image: node:20-alpine

variables:
  NODE_VERSION: "20"
  EXPO_TOKEN: $EXPO_TOKEN
  EAS_NO_VCS: "1"
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  CACHE_COMPRESSION_LEVEL: "fast"
  GIT_DEPTH: 50

# ============================================
# Cache Configuration
# ============================================

.node_cache: &node_cache
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/
  policy: pull-push

# ============================================
# Workflow Rules
# ============================================

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_TAG

# ============================================
# Stages
# ============================================

stages:
  - install
  - quality
  - test
  - build
  - sync

# ============================================
# Stage Templates
# ============================================

.base_job:
  before_script:
    - apk add --no-cache git
    - npm ci --cache .npm --prefer-offline
  cache:
    <<: *node_cache

# ============================================
# Install Stage
# ============================================

install_dependencies:
  stage: install
  script:
    - apk add --no-cache git
    - npm ci --cache .npm --prefer-offline
    - npm install -g eas-cli
    - echo "Dependencies installed successfully"
  cache:
    <<: *node_cache
    policy: push
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

# ============================================
# Code Quality Stage
# ============================================

typecheck:
  stage: quality
  extends: .base_job
  needs: ["install_dependencies"]
  script:
    - echo "Running TypeScript type checking..."
    - npm run typecheck
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

lint:
  stage: quality
  extends: .base_job
  needs: ["install_dependencies"]
  script:
    - echo "Running ESLint..."
    - npm run lint
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

format_check:
  stage: quality
  extends: .base_job
  needs: ["install_dependencies"]
  script:
    - echo "Checking code formatting..."
    - npm run format:check
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ============================================
# Test Stage
# ============================================

unit_tests:
  stage: test
  extends: .base_job
  needs: ["install_dependencies"]
  script:
    - echo "Running unit tests..."
    - npm test -- --passWithNoTests --ci
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# ============================================
# Build Stage
# ============================================

build_web:
  stage: build
  extends: .base_job
  needs: ["typecheck"]
  script:
    - echo "Building web version..."
    - npm run web:build
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

build_android_preview:
  stage: build
  extends: .base_job
  needs: ["typecheck"]
  script:
    - echo "Building Android APK (Preview)..."
    - npm install -g eas-cli
    - eas build --platform android --profile preview --non-interactive --no-wait
  environment:
    name: android-preview
    url: https://expo.dev
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual

# ============================================
# Sync Stage - Push to GitHub after merge to main
# ============================================

sync_to_github:
  stage: sync
  image: alpine:latest
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0
  before_script:
    - apk add --no-cache git
  script:
    - echo "Syncing to GitHub..."
    - git remote add github https://oauth2:${GITHUB_TOKEN}@github.com/3asoftwares/E-Storefront-Mobile.git || true
    - git push github HEAD:main --force
    - echo "Successfully synced to GitHub!"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
  needs: ["build_web"]
